# 附录：根据条目是否关联未解决的问题设置条目的状态

groovy

```groovy
import com.intland.codebeamer.controller.QueriesController
import com.intland.codebeamer.event.util.VetoException
import com.intland.codebeamer.controller.TrackerItemController
import com.intland.codebeamer.persistence.dto.base.NamedDto

if(!beforeEvent) return
// 评审即将完成时，根据评审条目是否关联未解决的问题设置条目的状态

queries = applicationContext.getBean(QueriesController.class)
controller  = applicationContext.getBean(TrackerItemController.class)

def draft = new NamedDto(2)
def accepted = new NamedDto(5)

def trackerItemDtos = []

// subject 是评审对象
subject.subjects.each{ s -> 
  // 1.获取条目对象
  def trackerItemDto = controller.getTrackerItem(event.request, s.id)
  trackerItemDto = trackerItemDto.clone()
  trackerItemDtos << trackerItemDto
  // 2.检查条目是否关联未解决的问题
  if(hasUnresolvedIssue(s.id)){
    logger.info("submit ${s.id} to draft")
    trackerItemDto.status = draft
  }else{
    logger.info("submit ${s.id} to accepted")
    trackerItemDto.status = accepted
  }
}

// 3. 提交修改
controller.updateTrackerItems(event.request, trackerItemDtos)

def hasUnresolvedIssue(reqId){
    // 针对条目，查询处于'新建','已分派'状态下的问题
    def /*QueriesResult*/ result = queries.executeQueryByQueryString(event.request, /*pageNo*/ 1, /*pageSize*/ 1, /*queryString*/ "tracker.id IN (4771) AND 'status' IN ('新建','已分派') AND SubjectID IN ($reqId)")
    return result.trackerItems.fullListSize > 0
}
```

