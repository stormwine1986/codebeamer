# 用户和用户组

用户具有以下形式的 URI：“/user/{id}”或“/user/{name}”，其中 {id} 是内部唯一用户 ID/编号，{name} 是唯一用户名。

还有特殊的 URI“/user/self”，它允许引用“Authorization”请求标头中传递的用户。

用户组的 URI 格式为：“/user/group/{id}”或“/user/group/{name}”，其中 {id} 是内部唯一组 ID/编号，{name} 是唯一组姓名。

请注意：用户或组名称可以更改，因此不能保证基于名称的 URI 始终标识相同/相同的资源，而基于不可变 ID 的 URI 可以。

## 获取用户架构

rest api

```bash
curl http://localhost:8080/rest/user/schema -u bond:007 | jq .
```

## 创建一个新用户

rest api

```bash
curl -X POST http://localhost:8080/rest/user -u bond:007 -d \
'{"name":"Alice","firstName":"Alice","lastName": "CB","email":"alice@cb.com"}'
```

请求正文必须包含具有所有必需属性的有效用户对象。<u>注：必须属性和所有有效属性可以参照“用户架构”</u>

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController
import com.intland.codebeamer.persistence.dto.UserDto

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)
def userDto = new UserDto()
userDto.name = "Bob"
userDto.firstName = "Bob"
userDto.lastName = "CB"
userDto.email = "bob@cb.com"
userDto = controller.createUser(event.request, userDto)

logger.info("user = $userDto")
```

## 获取有关现有用户的信息

rest api

```bash
curl http://localhost:8080/rest/user/Bob -u bond:007 | jq .
```

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)
def userDto = controller.getUser(event.request, "Bob")

logger.info("user = $userDto")
```

## 更新现有用户

rest api

```bash
curl -X PUT http://localhost:8080/rest/user -u bond:007 -d \
'{"uri":"/user/Bob","title":"Programer"}'
```

请求正文必须包含带有“uri”的用户对象以及要更新的属性。<u>注：所有有效属性可以参照“用户架构”</u>

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController
import com.intland.codebeamer.persistence.dto.UserDto

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)

// 获取用户并更新部分属性
def userDto = controller.getUser(event.request, "Bob")
userDto.address = "Jinan, Shandong"
controller.updateUser(event.request, userDto)

logger.info("It works")
```

## 获取用户列表

rest api

```bash
curl http://localhost:8080/rest/users/page/1?pagesize=50&filter=Alice -u bond:007
```

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)

def paginatedDtoList = controller.getUsersPage(event.request, /*page*/ 1 , /*pagesize*/ 50 , /*groupid,nullable*/ 1001 , /*filter,nullable*/ "CB")

logger.info("paginatedDtoList = $paginatedDtoList")
```

## 获取用户许可架构

rest api

```bash
curl http://localhost:8080/rest/user/license/schema -u bond:007 | jq .
```

## 获取可用的用户许可证

rest api

```bash
curl http://localhost:8080/rest/user/licenses -u bond:007 | jq .
```

这些是系统上安装的许可证。您无法通过 REST API 安装 codeBeamer 许可证，只能将用户与许可证相关联。

## 获取分配给特定用户的许可证

rest api

```bash
curl http://localhost:8080/rest/user/bond/licenses -u bond:007 | jq .
```

## 设置分配给特定用户的许可证

rest api

```bash
curl -X PUT http://localhost:8080/rest/user/bond/licenses -d \
'{"ALM":"USER_WITH_NAMED_LICENSE","Collab":"USER_WITH_NAMED_LICENSE"}'
```

## 获取用户权限架构

rest api

```bash
curl http://localhost:8080/rest/user/permission/schema -u bond:007 | jq .
```

## 获取所有可用的用户权限

rest api

```bash
curl http://localhost:8080/rest/user/permissions -u bond:007 | jq .
```

您无法创建、更新或删除用户权限，只能将权限分配给用户组。

## 获取特定用户的权限

rest api

```bash
curl http://localhost:8080/rest/user/bond/permissions -u bond:007 | jq .
```

您不能直接为用户分配权限。您只能将权限分配给用户组，然后使用户成为组成员。

## 获取用户组架构

rest api

```bash
curl http://localhost:8080/rest/user/group/schema -u bond:007 | jq .
```

## 获取定义的用户组

rest api

```bash
curl http://localhost:8080/rest/user/groups -u bond:007 | jq .
```

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)

def userGroups = controller.getUserGroups(event.request)
logger.info("userGroups = $userGroups")
```

## 创建新用户组

rest api

```bash
curl -X POST http://localhost:8080/rest/user/group -u bond:007 -d \
'{"name":"REST API Users","description":"All users that are allowed to use the REST API","permissions":[2,8]}'
```

<u>注：有效的用户组属性参照“用户组架构”；有效的权限列表参照“获取所有可用的用户权限”。</u>

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)

def params = [name:"REST API Users",description:"All users that are allowed to use the REST API",permissions:[2,8]]
def usergroup = controller.createUserGroup(event.request, params)

logger.info("usergroup = $usergroup")
```

## 获取有关用户组的信息

rest api

```bash
curl http://localhost:8080/rest/user/group/4367 -u bond:007 | jq .
```

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)

def usergroup = controller.getUserGroup(event.request, /*groupIdOrName*/ "4367")
logger.info("usergroup = $usergroup")
```

## 更新现有用户组

rest api

```bash
curl -X PUT http://localhost:8080/rest/user/group/4367 -u bond:007 -d \
'{"permissions":[2,8,1048576]}'
```

请求正文必须包含要更新的属性。<u>注：用户组有效属性参照“用户组架构”。</u>

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)

def params = [permissions:[2,8,1048576,2097152]]
controller.updateUserGroup(event.request, /*groupIdOrName*/ "4367", params)

logger.info("It works")
```

## 删除用户组

rest api

```bash
curl -X DELETE http://localhost:8080/rest/user/group/4367 -u bond:007
```

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)

controller.deleteUserGroup(event.request, /*groupIdOrName*/ "4367")

logger.info("It works")
```

## 获取用户组变更历史记录

rest api

```bash
curl http://localhost:8080/rest/user/group/1001/history -u bond:007 | jq .
```

## 获取当前用户组的所有成员

rest api

```bash
curl http://localhost:8080/rest/user/group/1001/members -u bond:007 | jq .
```

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)

def userDtos = controller.getGroupMembers(event.request, /*groupIdOrName*/ "1001", /*filter,nullable*/ "CB")

logger.info("userDtos = $userDtos")
```

## 设置用户组成员

rest api

```bash
curl -X PUT http://localhost:8080/rest/user/group/1000/members -u bond:007 -d \
'["/user/bond","/user/Alice"]'
```

请求正文必须包含一个用户对象数组，这些对象应该是该组的独占成员（用户 URI 就足够了）。

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)

def bond = controller.getUser(event.request, /*userIdOrName*/ "bond")
def alice = controller.getUser(event.request, /*userIdOrName*/ "Alice")
controller.setGroupMembers(event.request, /*groupIdOrName*/ "1000", /*members*/ [bond,alice])

logger.info("It works")
```

## 获取用户组的成员历史记录

rest api

```bash
curl http://localhost:8080/rest/user/group/1000/members/history -u bond:007 | jq .
```

## 获取特定用户当前所属的组

rest api

```bash
curl http://localhost:8080/rest/user/bond/groups -u bond:007 | jq .
```

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)

def usergroups = controller.getGroupsOfUser(event.request, /*userIdOrName*/ "bond")

logger.info("usergroups = $usergroups")
```

## 获取特定用户的组成员历史记录

rest api

```bash
curl http://localhost:8080/rest/user/bond/groups/history -u bond:007 | jq .
```

## 设置特定用户所属的组

rest api

```bash
curl -X PUT http://localhost:8080/rest/user/Alice/groups -u bond:007 -d \
'["/user/group/1001", "/user/group/External"]'
```

请求正文必须包含用户组数组（仅组 URI 就足够了）。

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)

def regUsers = controller.getUserGroup(event.request, /*groupIdOrName*/ "1001")
def external = controller.getUserGroup(event.request, /*groupIdOrName*/ "External")
controller.setGroupsOfUser(event.request, /*userIdOrName*/ "Alice", /*groups*/ [regUsers,external])

logger.info("It works")
```

## 使用户成为组的成员

rest api

```bash
curl -X PUT http://localhost:8080/rest/user/group/External/user/Alice -u bond:007 -d \
'Why it was necessary to add this user to this group'
```

请求正文是可选的，可以包含单个注释字符串。

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)

controller.addGroupMember(event.request, /*groupIdOrName*/ "External", /*userIdOrName*/ "Alice", /*commet*/ "")

logger.info("It works")
```

## 从组中删除用户

rest api

```bash
curl -X DELETE http://localhost:8080/rest/user/group/External/user/Alice -u bond:007 -d \
'It was necessary to remove this user from this group, because ...'
```

请求正文是可选的，可以包含单个注释字符串。

groovy script

```groovy
// Veto on exception 必须被设置为 True
import com.intland.codebeamer.controller.admin.UsersAndGroupsController

if(!beforeEvent) return

def controller = applicationContext.getBean(UsersAndGroupsController.class)

controller.removeGroupMember(event.request, /*groupIdOrName*/ "External", /*userIdOrName*/ "Alice", /*comment*/ "")

logger.info("It works")
```

## 获取特定组的特定用户的成员历史记录

rest api

```bash
curl http://localhost:8080/rest/user/group/External/user/Alice/history -u bond:007 | jq .
```

## 获取特定用户的照片

rest api

```bash
curl http://localhost:8080/rest/user/bond/photo -u bond:007 --output avator.jpg
```

警告！

该请求不会返回 JSON 正文，而是返回 JPEG 用户图像数据“Content-type: image/jpeg”。

## 设置特定用户的照片

rest api

```bash
curl -X PUT http://localhost:8080/rest/user/bond/photo -u bond:007 --data-binary @avator.jpg -H 'Content-Type: image/jpeg'
```

警告！

请求正文不能包含 JSON，而是图像数据“Content-type: image/*”。

## 删除特定用户的照片

rest api

```bash
curl -X DELETE http://localhost:8080/rest/user/bond/photo -u bond:007
```

